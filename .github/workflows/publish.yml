name: Publish to VS Code Marketplace

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]

concurrency:
  group: publish-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  packages: write

jobs:
  publish:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build extension
        run: bun run vscode:prepublish

      - name: Create VSIX package
        run: bun run vscode:package

      - name: Publish to Visual Studio Marketplace
        if: ${{ env.VSCE_PAT != '' }}
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: bun run vscode:publish -- --pat "${{ env.VSCE_PAT }}"

      - name: Publish to Open VSX Registry
        if: ${{ env.OVSX_PAT != '' }}
        env:
          OVSX_PAT: ${{ secrets.OVSX_PAT }}
        run: bun x ovsx publish --pat "${{ env.OVSX_PAT }}"
